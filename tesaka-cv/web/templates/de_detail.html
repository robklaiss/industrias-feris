{% extends "base.html" %}

{% block title %}Documento {{ doc.id }} - TESAKA-SIFEN{% endblock %}

{% block content %}
<div class="doc-detail">
    <div class="doc-header">
        <h2>Documento #{{ doc.id }}</h2>
        <div class="header-actions">
            {% if doc.last_status == 'signed_local' or doc.last_status == 'error' %}
            <form method="POST" action="/de/{{ doc.id }}/send" style="display: inline;">
                <button type="submit" class="btn-primary" onclick="return confirm('¬øEnviar este documento a SIFEN?');">
                    üì§ Enviar a SIFEN
                </button>
            </form>
            {% endif %}
            {% if doc.last_status == 'sent_to_sifen' or doc.last_status == 'pending_sifen' or doc.last_status == 'error' %}
            <form method="GET" action="/de/{{ doc.id }}/status{% if doc.last_status == 'error' %}?force=1{% endif %}" style="display: inline;">
                <button type="submit" class="btn-secondary">
                    üîç Consultar Estado en SIFEN
                </button>
            </form>
            {% endif %}
            <a href="/" class="btn-back">‚Üê Volver</a>
        </div>
    </div>

    <div class="doc-metadata">
        <h3>Informaci√≥n General</h3>
        <table class="metadata-table">
            <tr>
                <th>ID:</th>
                <td>{{ doc.id }}</td>
            </tr>
            <tr>
                <th>CDC:</th>
                <td><code>{{ doc.cdc or 'N/A' }}</code></td>
            </tr>
            <tr>
                <th>RUC Emisor:</th>
                <td>{{ doc.ruc_emisor or 'N/A' }}</td>
            </tr>
            <tr>
                <th>Timbrado:</th>
                <td>{{ doc.timbrado or 'N/A' }}</td>
            </tr>
            <tr>
                <th>Fecha de Creaci√≥n:</th>
                <td>{{ doc.created_at if doc.created_at else 'N/A' }}</td>
            </tr>
            <tr>
                <th>Estado:</th>
                <td>
                    <span class="status-badge status-{{ doc.last_status|lower|replace('_', '-') if doc.last_status else 'unknown' }}">
                        {% if doc.last_status == 'signed_local' %}
                            FIRMADO LOCALMENTE: pendiente de env√≠o a SIFEN.
                        {% elif doc.last_status == 'sent_to_sifen' %}
                            ENVIADO A SIFEN: recibido, en espera de validaci√≥n/aprobaci√≥n.
                        {% elif doc.last_status == 'pending_sifen' %}
                            ENVIADO A SIFEN: en espera de validaci√≥n/aprobaci√≥n.
                        {% elif doc.last_status == 'approved' %}
                            APROBADO POR SIFEN: DE emitido y autorizado{% if doc.approved_at %} (Aprobado el {{ doc.approved_at }}){% endif %}.
                        {% elif doc.last_status == 'rejected' %}
                            RECHAZADO POR SIFEN{% if doc.last_code or doc.last_message %}: {% if doc.last_code %}{{ doc.last_code }}{% endif %}{% if doc.last_code and doc.last_message %} - {% endif %}{% if doc.last_message %}{{ doc.last_message }}{% endif %}{% endif %}.
                        {% elif doc.last_status == 'error' %}
                            ERROR: problema en el proceso{% if doc.last_message %}: {{ doc.last_message }}{% endif %}.
                        {% else %}
                            {{ doc.last_status or 'N/A' }}
                        {% endif %}
                    </span>
                </td>
            </tr>
            {% if doc.d_prot_cons_lote %}
            <tr>
                <th>Protocolo de Lote:</th>
                <td><code>{{ doc.d_prot_cons_lote }}</code></td>
            </tr>
            {% endif %}
            {% if doc.approved_at %}
            <tr>
                <th>Fecha de Aprobaci√≥n:</th>
                <td>{{ doc.approved_at }}</td>
            </tr>
            {% endif %}
            <tr>
                <th>C√≥digo:</th>
                <td><code>{{ doc.last_code or 'N/A' }}</code></td>
            </tr>
            <tr>
                <th>Mensaje:</th>
                <td>{{ doc.last_message or 'N/A' }}</td>
            </tr>
        </table>
    </div>

    <div class="doc-xmls">
        <h3>XML del Documento Electr√≥nico</h3>
        <details class="xml-block" open>
            <summary>DE (Documento Electr√≥nico)</summary>
            <pre class="xml-content">{{ doc.de_xml or '(vac√≠o)' }}</pre>
        </details>
    </div>
</div>
{% endblock %}

