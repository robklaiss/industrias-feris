{% extends "layout.html" %}

{% block title %}Nueva Remisión - Industrias Feris{% endblock %}

{% block content %}
<h2>Nueva Remisión</h2>

<form method="post" action="/remissions">
    <div class="form-row">
        <div class="form-group">
            <label for="fecha_inicio">Fecha Inicio *</label>
            <input type="date" id="fecha_inicio" name="fecha_inicio" required>
        </div>
        <div class="form-group">
            <label for="fecha_fin">Fecha Fin</label>
            <input type="date" id="fecha_fin" name="fecha_fin">
        </div>
    </div>
    
    <div class="form-row">
        <div class="form-group">
            <label for="partida">Punto de Partida</label>
            <input type="text" id="partida" name="partida">
        </div>
        <div class="form-group">
            <label for="llegada">Punto de Llegada</label>
            <input type="text" id="llegada" name="llegada">
        </div>
    </div>
    
    <div class="form-row">
        <div class="form-group">
            <label for="vehiculo_marca">Vehículo (Marca)</label>
            <input type="text" id="vehiculo_marca" name="vehiculo_marca">
        </div>
        <div class="form-group">
            <label for="chapa">Chapa</label>
            <input type="text" id="chapa" name="chapa">
        </div>
    </div>
    
    <div class="form-row">
        <div class="form-group">
            <label for="transportista_nombre">Transportista (Nombre)</label>
            <input type="text" id="transportista_nombre" name="transportista_nombre">
        </div>
        <div class="form-group">
            <label for="transportista_ruc">Transportista (RUC)</label>
            <input type="text" id="transportista_ruc" name="transportista_ruc">
        </div>
    </div>
    
    <div class="form-row">
        <div class="form-group">
            <label for="conductor_nombre">Conductor (Nombre)</label>
            <input type="text" id="conductor_nombre" name="conductor_nombre">
        </div>
        <div class="form-group">
            <label for="conductor_ci">Conductor (CI)</label>
            <input type="text" id="conductor_ci" name="conductor_ci">
        </div>
    </div>
    
    <div class="form-row">
        <div class="form-group">
            <label for="contract_id">Contrato</label>
            <select id="contract_id" name="contract_id">
                <option value="">Seleccionar contrato...</option>
                {% for contract in contracts %}
                <option value="{{ contract.id }}">
                    {{ contract.numero_contrato }}
                </option>
                {% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="client_id">Cliente</label>
            <select id="client_id" name="client_id">
                <option value="">Seleccionar cliente...</option>
                {% for client in clients %}
                <option value="{{ client.id }}">
                    {{ client.nombre }} ({{ client.ruc or 'Sin RUC' }})
                </option>
                {% endfor %}
            </select>
        </div>
    </div>
    
    <h3>Items</h3>
    <div id="items-container">
        <div class="item-row" style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 0.5rem; margin-bottom: 0.5rem; align-items: end;">
            <select name="producto" class="product-select" onchange="fillProductData(this)" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                <option value="">Seleccionar producto...</option>
                {% for product in products %}
                <option value="{{ product.nombre }}" 
                        data-unidad="{{ product.unidad_medida }}">
                    {{ product.nombre }}{% if product.codigo %} ({{ product.codigo }}){% endif %}
                </option>
                {% endfor %}
            </select>
            <input type="text" name="unidad_medida" placeholder="Unidad" required readonly style="background: #f5f5f5;">
            <input type="number" step="0.01" name="cantidad" placeholder="Cantidad" required>
            <button type="button" class="btn btn-danger" onclick="removeItem(this)" style="padding: 0.5rem;">❌</button>
        </div>
    </div>
    
    <button type="button" class="btn" onclick="addItem()" style="margin-bottom: 1rem;">➕ Agregar Item</button>
    
    <div style="margin-top: 2rem;">
        <button type="submit" class="btn btn-success">Guardar</button>
        <a href="/remissions" class="btn">Cancelar</a>
    </div>
</form>

<script>
function addItem() {
    const container = document.getElementById('items-container');
    const newRow = document.createElement('div');
    newRow.className = 'item-row';
    newRow.style.cssText = 'display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 0.5rem; margin-bottom: 0.5rem; align-items: end;';
    
    const productSelect = container.querySelector('.product-select');
    const productOptions = productSelect ? productSelect.innerHTML : '<option value="">Seleccionar producto...</option>';
    
    newRow.innerHTML = `
        <select name="producto" class="product-select" onchange="fillProductData(this)" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
            ${productOptions}
        </select>
        <input type="text" name="unidad_medida" placeholder="Unidad" required readonly style="background: #f5f5f5;">
        <input type="number" step="0.01" name="cantidad" placeholder="Cantidad" required>
        <button type="button" class="btn btn-danger" onclick="removeItem(this)" style="padding: 0.5rem;">❌</button>
    `;
    container.appendChild(newRow);
}

function fillProductData(select) {
    const row = select.closest('.item-row');
    const unidadInput = row.querySelector('input[name="unidad_medida"]');
    const selectedOption = select.options[select.selectedIndex];
    
    if (selectedOption.value) {
        unidadInput.value = selectedOption.getAttribute('data-unidad') || '';
    } else {
        unidadInput.value = '';
    }
}

function removeItem(btn) {
    const container = document.getElementById('items-container');
    if (container.children.length > 1) {
        btn.closest('.item-row').remove();
    } else {
        alert('Debe haber al menos un item');
    }
}
</script>
{% endblock %}

